worker_processes 2;

events {
    worker_connections 1024;
}

http {

    include mime.types;
    sendfile on;
    keepalive_timeout 75;

    proxy_http_version 1.1;
    proxy_buffering on;
    proxy_read_timeout 60;
    proxy_connect_timeout 60;
    client_max_body_size 400M;

    # Server block to listen on port 80
    server {
        listen 80;
        listen [::]:80;

        # Root directory for your app
        root /app/public;
        index index.php index.html index.htm;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";

        # Handle main location requests
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        # Disable access logging for favicon and robots.txt
        location = /favicon.ico { 
            access_log off; log_not_found off; 
        }
        location = /robots.txt { 
            access_log off; log_not_found off; 
        }

        # Error handling (404 goes to index.php)
        error_page 404 /index.php;

        # PHP processing through FastCGI (using the php-container)
        location ~ \.php$ {
            fastcgi_pass php:9000;  # FastCGI backend (php-fpm container)
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }
}
